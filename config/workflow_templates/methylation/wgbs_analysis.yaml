# WGBS Methylation Analysis Template
# ===================================

name: wgbs_analysis
display_name: "Whole Genome Bisulfite Sequencing Analysis"
version: "1.0.0"
category: methylation
engine: nextflow

description: |
  Complete WGBS analysis pipeline from raw bisulfite sequencing data
  to methylation calls, DMR detection, and visualization. Uses Bismark
  for alignment and methylKit/DSS for differential methylation analysis.

tags:
  - wgbs
  - methylation
  - bisulfite-sequencing
  - dmr
  - epigenetics

inputs:
  required:
    - name: input_dir
      type: path
      description: Directory containing FASTQ files
    
    - name: organism
      type: string
      description: Reference organism
      enum: [human, mouse]
    
    - name: sample_sheet
      type: file
      description: Sample metadata CSV
  
  optional:
    - name: aligner
      type: string
      description: Bisulfite aligner
      default: bismark
      enum: [bismark, bwa-meth]
    
    - name: genome_build
      type: string
      default: auto
    
    - name: min_coverage
      type: integer
      description: Minimum read coverage for methylation calls
      default: 10
    
    - name: dmr_caller
      type: string
      description: DMR detection tool
      default: methylKit
      enum: [methylKit, DSS, dmrseq]
    
    - name: dmr_threshold
      type: number
      description: Methylation difference threshold
      default: 0.25
    
    - name: q_value
      type: number
      description: Q-value threshold for DMRs
      default: 0.01
    
    - name: context
      type: list
      description: Methylation contexts to analyze
      default: [CpG]

steps:
  - name: fastqc
    description: Quality control
    tool: fastqc
    inputs:
      reads: "${input_dir}/*.fastq.gz"
    outputs:
      reports: "qc/fastqc/"

  - name: trim_galore
    description: Adapter trimming for bisulfite data
    tool: trim_galore
    inputs:
      reads: "${input_dir}/*.fastq.gz"
    outputs:
      trimmed: "trimmed/*.fq.gz"
    params:
      quality: 20
      clip_R2: 2

  - name: bismark_align
    description: Bisulfite alignment
    tool: bismark
    inputs:
      reads: "trimmed/*.fq.gz"
      genome: "${reference_dir}/bismark_index"
    outputs:
      bam: "aligned/*.bam"
      report: "aligned/*.txt"
    params:
      multicore: 4

  - name: deduplicate
    description: Remove PCR duplicates
    tool: bismark_deduplicate
    inputs:
      bam: "aligned/*.bam"
    outputs:
      dedup_bam: "dedup/*.bam"

  - name: methylation_extraction
    description: Extract methylation calls
    tool: bismark_methylation_extractor
    inputs:
      bam: "dedup/*.bam"
    outputs:
      calls: "methylation/"
      bedgraph: "methylation/*.bedGraph"
      coverage: "methylation/*.cov"
    params:
      comprehensive: true
      bedGraph: true
      cytosine_report: true

  - name: coverage_filter
    description: Filter by coverage
    tool: methylKit
    inputs:
      coverage: "methylation/*.cov"
    outputs:
      filtered: "filtered/"
    params:
      min_coverage: "${min_coverage}"
      max_percentile: 99.9

  - name: dmr_analysis
    description: Differential methylation analysis
    tool: "${dmr_caller}"
    inputs:
      methylation: "filtered/"
      sample_sheet: "${sample_sheet}"
    outputs:
      dmrs: "dmr/results/"
      plots: "dmr/plots/"
    params:
      difference: "${dmr_threshold}"
      qvalue: "${q_value}"

  - name: annotation
    description: Annotate DMRs
    tool: annotatr
    inputs:
      dmrs: "dmr/results/*.bed"
      genome: "${organism}"
    outputs:
      annotated: "dmr/annotated/"

  - name: visualization
    description: Generate methylation visualizations
    tool: methylation_plots
    inputs:
      methylation: "methylation/"
      dmrs: "dmr/results/"
    outputs:
      heatmaps: "plots/heatmaps/"
      profiles: "plots/profiles/"
      pca: "plots/pca.pdf"

  - name: multiqc
    description: Aggregate QC
    tool: multiqc
    inputs:
      - "qc/"
      - "aligned/"
      - "methylation/"
    outputs:
      report: "qc/multiqc_report.html"

outputs:
  primary:
    - name: dmrs
      path: "dmr/results/"
      description: Differentially methylated regions
    - name: methylation_calls
      path: "methylation/"
      description: Per-base methylation levels
  
  secondary:
    - name: qc_report
      path: "qc/multiqc_report.html"
    - name: plots
      path: "plots/"
    - name: annotated_dmrs
      path: "dmr/annotated/"

resources:
  default:
    cpus: 4
    memory: "32 GB"
    time: "24h"
  
  bismark_align:
    cpus: 16
    memory: "64 GB"
    time: "48h"
  
  methylation_extraction:
    cpus: 8
    memory: "32 GB"
    time: "12h"
