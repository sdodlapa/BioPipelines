Bootstrap: localimage
From: /scratch/sdodl001/containers/base_1.0.0.sif

%labels
    org.opencontainers.image.version="1.0.0"
    org.opencontainers.image.authors="BioPipelines Team"
    org.opencontainers.image.title="BioPipelines DNA-seq Container"
    org.opencontainers.image.description="DNA sequencing analysis pipeline with BWA, GATK, and variant calling tools"
    pipeline.name="dna-seq"
    pipeline.version="1.0.0"

%files
    entrypoint.sh /opt/biopipelines/entrypoint.sh
    run_pipeline.sh /opt/biopipelines/run_pipeline.sh

%post
    # Install DNA-seq specific tools
    micromamba install -y -n base -c conda-forge -c bioconda \
        bwa=0.7.18 \
        bwa-mem2=2.2.1 \
        bowtie2=2.5.4 \
        gatk4=4.6.0.0 \
        picard=3.1.1 \
        freebayes=1.3.6 \
        vcftools=0.1.16 \
        bcftools=1.19 \
        snpeff=5.2 \
        vep=111.0 \
        fastp=0.23.4 \
        trimmomatic=0.39 \
        cutadapt=4.4 \
        qualimap=2.3 \
        r-base=4.3 \
        bioconductor-variantannotation \
        bioconductor-genomicranges

    # Make scripts executable
    chmod +x /opt/biopipelines/entrypoint.sh /opt/biopipelines/run_pipeline.sh
    
    # Create pipeline directory
    mkdir -p /opt/biopipelines/dna_seq

    # Clean up
    micromamba clean --all --yes

%environment
    export PIPELINE_NAME="dna-seq"
    export PIPELINE_VERSION="1.0.0"

%runscript
    exec /opt/biopipelines/entrypoint.sh "$@"

%test
    # Test DNA-seq tools
    bwa 2>&1 | head -1
    gatk --version
    picard MarkDuplicates --version 2>&1 | head -1
    freebayes --version
    echo "DNA-seq container validation passed"
