Bootstrap: localimage
From: /scratch/sdodl001/containers/base_1.0.0.sif

%labels
    org.opencontainers.image.version="1.0.0"
    org.opencontainers.image.authors="BioPipelines Team"
    org.opencontainers.image.title="BioPipelines scRNA-seq Container"
    org.opencontainers.image.description="Single-cell RNA-seq analysis with Seurat, Scanpy, and Cell Ranger"
    pipeline.name="scrna-seq"
    pipeline.version="1.0.0"

%files
    entrypoint.sh /opt/biopipelines/entrypoint.sh
    run_pipeline.sh /opt/biopipelines/run_pipeline.sh

%post
    # Install scRNA-seq specific tools
    micromamba install -y -n base -c conda-forge -c bioconda \
        star=2.7.11a \
        salmon=1.10.3 \
        velocyto.py=0.17.17 \
        scrublet=0.2.3 \
        scanpy=1.10.4 \
        anndata=0.10.9 \
        scikit-learn \
        umap-learn \
        leiden \
        louvain \
        r-base=4.3 \
        r-seurat=5.1.0 \
        bioconductor-singlecellexperiment \
        bioconductor-scater \
        bioconductor-scran \
        r-ggplot2 \
        r-cowplot \
        r-patchwork \
        python=3.11 \
        numpy \
        pandas \
        scipy \
        matplotlib \
        seaborn

    # Make scripts executable
    chmod +x /opt/biopipelines/entrypoint.sh /opt/biopipelines/run_pipeline.sh
    
    # Create pipeline directory
    mkdir -p /opt/biopipelines/scrna_seq

    # Clean up
    micromamba clean --all --yes

%environment
    export PIPELINE_NAME="scrna-seq"
    export PIPELINE_VERSION="1.0.0"

%runscript
    exec /opt/biopipelines/entrypoint.sh "$@"

%test
    # Test scRNA-seq tools
    python -c "import scanpy; print('Scanpy:', scanpy.__version__)"
    python -c "import anndata; print('AnnData:', anndata.__version__)"
    Rscript -e "library(Seurat); cat('Seurat loaded\n')"
    echo "scRNA-seq container validation passed"
