Bootstrap: docker
From: mambaorg/micromamba:1.5.8

%labels
    org.opencontainers.image.title="BioPipelines Base Container"
    org.opencontainers.image.description="Foundation container with common bioinformatics tools"
    org.opencontainers.image.version="1.0.0"
    org.opencontainers.image.authors="BioPipelines Team <sdodlapa@github>"
    org.opencontainers.image.source="https://github.com/sdodlapa/BioPipelines"
    ai.agent.category="bioinformatics"
    ai.agent.tier="base"

%post
    # Install common tools shared across all pipelines
    # Core utilities (used across most pipelines)
    micromamba install -y -n base -c conda-forge -c bioconda \
        samtools=1.17 \
        bcftools=1.17 \
        htslib=1.17 \
        bedtools=2.30.0 \
        fastqc=0.12.1 \
        multiqc=1.14 \
        python=3.11 \
        numpy \
        pandas \
        scipy \
        matplotlib \
        seaborn \
        biopython \
        pysam \
        pybedtools \
        parallel \
        pigz
    
    # High-frequency alignment & preprocessing tools (5+ pipelines)
    micromamba install -y -n base -c conda-forge -c bioconda \
        fastp=0.23.4 \
        bowtie2=2.5.4 \
        bwa=0.7.18 \
        trimmomatic=0.39 \
        cutadapt
    
    # R ecosystem & visualization (9 pipelines use r-base)
    micromamba install -y -n base -c conda-forge -c bioconda \
        r-base=4.3 \
        r-ggplot2 \
        r-pheatmap \
        bioconductor-genomicranges
    
    # Common tools used by 3+ pipelines
    micromamba install -y -n base -c conda-forge -c bioconda \
        picard=3.1.1
    
    # Clean up
    micromamba clean --all --yes
    
    # Create working directories
    mkdir -p /analysis /data /results
    chmod -R 777 /analysis /data /results

%environment
    export PATH="/opt/conda/bin:$PATH"
    export PYTHONUNBUFFERED=1

%runscript
    exec /bin/bash "$@"

%test
    samtools --version
    fastqc --version
    bowtie2 --version | head -1
    bwa 2>&1 | head -1
    fastp --version 2>&1 | head -1
    Rscript -e "library(ggplot2); cat('R packages loaded\n')"
    echo "Base container validation passed"
